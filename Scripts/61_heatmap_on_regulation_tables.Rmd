---
title: "k means on regulation tables by Anja"
output: html_notebook
---


# Description
Here we cluster genes based on information on their regulation.
I use Anja's script for heatmap with k means clustering

# Libraries
```{r}
# library(stringr)
 library(RColorBrewer)
# library(ALDEx2)
# library(stringi)
# library(nortest)
 library(dplyr)
# library(effsize)
 library(writexl)
 library(readxl)
 library(viridis) # magma colour scheme is likeable
 library(pheatmap)
# library(tibble)
options(scipen=999)


```

define colours to use and breakpoints for the colour scale
```{r}

#tu promjeniti
#heatmap.col.breaks <- c(-1.1, -0.5, -0.3, -0.2, -0.1, 0.1, 0.2, 0.3, 0.5, 1.1)
#colors for scale
heatmap.col_vec2 <- brewer.pal(n=9, name="RdBu")
centers=8 # numbers of clusters to try out (inspect plots then eliminate)

```



# main plotting function
annotRows is df with row annotation, 
gaps is white space based on cluster sizes, dat is matrix with values

```{r}

plot_pheatmap <- function(dat, colVec, colBreaks, annotRows, gaps, prefix){
  f <- paste0(prefix, ".png") # prefix defines plot filename
  
  # various colour schemes for annotation columns
  clPurp <- brewer.pal(4, "Purples")
  clPurp[1] <- "white"
  clGr <- brewer.pal(4, "Greens")
  # clGr[1] <- "white"
  clPink <- brewer.pal(4, "RdPu")
  clPink[1] <- "white"
  clPanel <- brewer.pal(8, "Set2")
  clClus <- brewer.pal(12, "Paired")
  
  # assigning schemes to columns in annotRows 
  ann_colors=list(
    Cluster=clClus[1:length(unique(annotRows$Cluster))],
    Cpg_num = brewer.pal(8,"Greys"))
    #Abundance_F=clPink,
    #Abundance_T= clClus,
    #bundance_F=clPink,
    #Abundance= c(Rare=clGr[1], Low=clGr[2], Intermediate=clGr[3], Abundant=clGr[4]),
    
    #    Disease=c(noDisease="white", CD=clPurp[1], `CD,UC`=clPurp[2], UC=clPurp[3]),
  #  names(ann_colors$Cluster) <- levels(annotRows$Cluster)
  # names(ann_colors$abundance) <- levels(annotRows$abundance)
  #  names(ann_colors$Panel) <- levels(annotRows$Panel)
  names(ann_colors$Cluster) <- unique(annotRows$Cluster)
  
  pheatmap(
    mat=dat,
    color=colVec,
    #breaks=colBreaks,
    #legend_breaks=colBreaks,
    # #annotation_row=tb$kmeans,
    annotation_row=annotRows,
    #annotation_col=annotCols,
    annotation_colors=ann_colors,
    show_rownames=F,
    fontsize_row=5,
    gaps_row=gaps,
    cluster_rows=F, 
    cluster_cols=F,
    border_color='white',    
    filename=f)
}


```

```{r}
brewer.pal(10,"Paired")
```


# table
```{r}
# load table of input data
reg.table.FC <- read_xlsx("Results/60_regulation_table_foldchange.xlsx")
#tb <- tibble::column_to_rownames(reg.table.FC, var="genes")[sample(2660, 100),]
tb <- tibble::column_to_rownames(reg.table.FC, var="genes")

# select only numeric columns we wish to use for clustering
tb <- dplyr::select(tb, 
                    FC, 
                    mir.log2FoldChange, 
                    mean.quot.log2)
```

Visualizing data from table
```{r, eval=FALSE}
for(i in c(1:3)){
  print(i)
  boxplot(tb[,i])
}

tb$mean.quot.log2 <- tb$mean.quot.log2*1.5
tb$mir.log2FoldChange <- tb$mir.log2FoldChange*1.5


tb[is.na(tb)] <- 0

for(i in c(1:3)){
  print(i)
  hist(tb[,i])
}

```


renaming columns
```{r}
tb[is.na(tb)] <- 0
tb <- dplyr::rename(tb, 
                    FC_genes = FC,
                    FC_mir = mir.log2FoldChange,
                    FC_methyl = mean.quot.log2)
```


# main
```{r}
# consider which annotation we'd like to add
centers=8:13 # numbers of clusters to try out (inspect plots then eliminate)
nstarts <- 50
timestamp <- Sys.time()
timestamp <- format(timestamp, "%Y%m%d_%H%M_")

for (c in centers){
  print(paste0("Processing kmeans with ", c, " clusters."))
  
  # nstart ensures stability of results, otherwise you get a different kmeans every time
  k <- kmeans(tb, centers=c, nstart=nstarts) 
  
  # reorder rows by clustering
  tb$kmeans <- as.character(k$cluster)
  tb <- tb[order(as.numeric(tb$kmeans)),]
  
  # specify whitespace between clusters
  x <- table(as.numeric(tb$kmeans))
  gps <- numeric(length(x))
  for(i in 1:length(x)){
    gps[i:length(x)] <- gps[i:length(x)]+x[i]
  }
  # row annotation, adjust to whatever you're using
  annotRows <- data.frame(Cluster =tb$kmeans, Cpg_num = reg.table.FC$cpg_promoters)
  annotRows[is.na(annotRows)]<- 0
 
  rownames(annotRows) <- rownames(tb)
  #colnames(annotRows) <- "Cluster"
  # annotRows$abundance <- sapply(rownames(annotRows), function(x){
  #   dfAbund$bin[dfAbund$fam==x]
  # }, simplify=T)
  
  
  
  # number of clusters, filename prefix
  plot_pheatmap(dat=tb[,1:(ncol(tb)-1)],
                colVec=heatmap.col_vec2,
                #colBreaks=heatmap.col.breaks,
                annotRows=annotRows,
                gaps=gps,
                prefix=paste0("clustering/",timestamp,"_", c,
                              "clusters","_",nstarts,"_nstart"))
  saveRDS(tb, paste0("clustering/",timestamp,c,"_clusters_",nstarts,"nstart","_data"))
}
```


```{r}
sessionInfo()
```

